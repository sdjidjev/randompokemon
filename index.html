<!DOCTYPE html>
<html ng-app>
	<head>
		 <link rel="icon" href="favicon.ico" type="image/x-icon">
		<link href='http://fonts.googleapis.com/css?family=Merriweather+Sans:400,300' rel='stylesheet' type='text/css'>
		<link href='http://fonts.googleapis.com/css?family=Niconne' rel='stylesheet' type='text/css'>
		<title>Random Pokemon! </title>
		<link href="index.css" type = "text/css" rel = "stylesheet">

		<script type="text/javascript" src="./base32.js"></script>
		<script type="text/javascript" src="./angular.min.js"></script>

		<script>

			function pokemans($scope) {
				$scope.text = "Wow. A Pokemon appeared! Wow.";

				$scope.range = function(n) {
					return new Array(n);
				};

				$scope.getPokemonString = function(n) {
					var num;
					if (n < 10) {
						num = '00' + String(n);
					} else if (n < 100) {
						num = '0' + String(n);
					} else if (n < 1000) {
						num = String(n);
					}
					return num;
				}

				$scope.getBinary = function() {
					var b64 = window.localStorage.getItem('pokemans');
					if (!b64) {
						return new Array(650).join("0");
					} else {
						var b64arr = b64.split(",");
						var binaryString = "";
						for (var i = 0; i < b64arr.length; i += 2) {
							var binaryPart = parseInt(atob(b64arr[i+1]), 16).toString(2);
							while (binaryPart.length < parseInt(b64arr[i])) {
								binaryPart = "0" + binaryPart;
							}
							binaryString += binaryPart;
						}
						return binaryString;
					}
				}

				$scope.setBinary = function(binary) {
					var storeVal = "";
					for (var i = 0; i < binary.length; i += 64) {
						if (i+64 >= binary.length) {
							storeVal += (binary.length - i) + ","
						} else {
							storeVal += "64,";
						}
						storeVal += btoa(parseInt(binary.substring(i, i+64), 2).toString(16));
						if (i < binary.length - 64) {
							storeVal += ","
						}
					}
					window.localStorage.setItem('pokemans', storeVal);
				}

				$scope.getPokemon = function(num) {
					var binary = $scope.getBinary();
					var num2 = num-1;
					binary = binary.substring(0, num2) + '1' + binary.substring(num2+1);
					$scope.setBinary(binary);
					return num;
				};

				$scope.getProgress = function() {
					var binary = $scope.getBinary();
					return (binary.split("0").length - 1) + "/649 pokemans left";
				};

				$scope.isShiny = function(){
					var num = Math.floor(Math.random()*1000);
					var str = "";
					if (num == 2 || num == 1){
						return true;
					}
					else{
						return false
					}
				};

				$scope.isWinner = function() {
					var binary = $scope.getBinary()
					if (binary.indexOf("0") == -1) {
						return true;
					} else {
						return false;
					}
				}

				$scope.reset = function(){
					$scope.setBinary(new Array(649).join("0"));
					$scope.winner = $scope.isWinner();
				}

				$scope.findPokemon = function(num, p, $index) {
					if (!$scope.found && num == p) {
						$scope.found = $index;
						return true;
					} else if ($scope.found && num == p && $scope.found == $index) {
						return true;
					} else {
						return false;
					}
				}

				$scope.queue = [];
				for (var i = 0; i < 20; i++) {
					$scope.queue.push(Math.floor(Math.random() * 649) + 1);
				}

				$scope.update = function() {
					$scope.found = null;
					$scope.pokemontype = "i"
					$scope.queue.shift();
					$scope.num = $scope.getPokemon($scope.queue[0]);
					$scope.queue.push(Math.floor(Math.random() * 649) + 1);
					$scope.shiny = $scope.isShiny();
					$scope.winner = $scope.isWinner();
					if ($scope.shiny) {
						$scope.pokemontype = "s";
					}
				};

				$scope.update();
			}
		</script>

	</head>
	
	<body>

		<div ng-controller="pokemans" align=center>

			<div>{{text}}</div>
			<div>{{getProgress()}}</div>
			<div>
				<img ng-repeat="p in queue" ng-show="findPokemon(num, p, $index)" ng-src="http://sprites.pokecheck.org/{{pokemontype}}/{{getPokemonString(p)}}.gif" height="150px"></img>
			</div>
			<div ng-show="shiny">look is a shiny</div>
			<div ng-show="winner">a winner is u</div>
			<button ng-click="update()">new</button>
			<button ng-click="reset()" ng-show = "winner">reset if u want</button>
		</div>
</body>
</html>
